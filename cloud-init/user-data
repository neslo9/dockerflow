#cloud-config
hostname: kube-harbor
users:
  - name: fedora
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: wheel,docker
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCtmamvpt1yrmm0yBHNCHmkdXrkye6Hv0z9ivIokJonm5Vi3HKsU+YHvwgn/LWsqF61VlJ0eFku/q3Z3uPby6Bw5j59b1MO5dAnKUClvFgoyvkvG50h85NXsYns8vaIwBb4m7SxYRdiEewVvqOVgdjeVODJBm/fMM5+pTHOKsb0jvAKVn99nFib9PT7LUPk36Au79HGcvkYJ5UX2eTjS8bAzxOlXl1DKgIlyXCJZJZGbFknM1SvWxt2ZwcBiT1vPylLcPtyeEJ2PjP421xBi8Iz8mmqi9WpfGdjhjoT/+OLoOqFPC4dSObcoiZc6ipJIlC5DoxuSZPMQ0UxGBHn70sNu17yGzrmdLPJBGdW7p80sa7cQSMlBEyI9mJsS3bVD9HzAYkTgLW/m7i2lb9mBasSINd6NNd0kHrF1rIXkZ1PH3QCNs0TaaQlC87EvEMMcZTl0G3LdFgetvbN5fnyEWJZcBVl6mHbIdbfPuteDDv1fZ0T+jfMiwL8hTNPkYHjRBk= hypervisoradmin@hypervisor
    passwd: '$2y$10$abcdefghijklmnopqrstuvABCDEFGHIJ1234567890abcdef'

packages:
  - docker
  - docker-compose
  - git
  - curl
  - wget
  - tar
  - conntrack
  - socat
  - python3
  - python3-pip
  - rsyslog
  - policycoreutils-python-utils  # dla semanage
 
write_files:
  - path: /etc/rsyslog.d/harbor.conf
    content: |
      module(load="imtcp")
      input(type="imtcp" port="1514")
      action(type="omfile" file="/var/log/harbor.log")
    owner: root:root
    permissions: '0644'

runcmd:
  # Włącz usługi
  - [ systemctl, enable, "--now", docker ]
  - [ systemctl, enable, "--now", rsyslog ]
  - [ groupadd, docker ]
  - [ usermod, -aG, docker, fedora ]
  - [ setsebool, -P, rsyslog_tcp_server, on ]

  # SELinux: zezwól rsyslogowi na port TCP
  - [ semanage, port, "-a", "-t", "syslogd_port_t", "-p", "tcp", "1514" ]

  # Fix uprawnienia do katalogów Harbor
  - [ mkdir, "-p", "/data", "/etc/harbor/ssl", "/harbor_cust_cert" ]
  - [ chown, "-R", "10000:10000", "/data" ]
  - [ chmod, "755", "/harbor_cust_cert" ]

  # Minikube
  - [ curl, "-Lo", "/usr/local/bin/minikube", "https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64" ]
  - [ chmod, "+x", "/usr/local/bin/minikube" ]
  - [ su, "-", "fedora", "-c", "minikube start --driver=docker --memory=6144 --cpus=4" ]

  # Harbor
  - [ "bash", "-lc", "\
      curl -Lo /tmp/harbor.tgz https://github.com/goharbor/harbor/releases/download/v2.10.0/harbor-online-installer-v2.10.0.tgz && \
      tar xzvf /tmp/harbor.tgz -C /opt && \
      cd /opt/harbor && \
      cp harbor.yml.tmpl harbor.yml && \
      sed -i 's/^hostname:.*/hostname: 192.168.122.100/' harbor.yml && \
      sed -i 's/^harbor_admin_password:.*/harbor_admin_password: Harbor12345/' harbor.yml && \
      sed -i 's|^data_volume:.*|data_volume: /data|' harbor.yml && \
      sed -i 's/^https:/#https:/' harbor.yml && \
      sed -i 's/^  port: 443/#  port: 443/' harbor.yml && \
      sed -i 's/^  certificate:/#  certificate:/' harbor.yml && \
      sed -i 's/^  private_key:/#  private_key:/' harbor.yml && \
      sed -i '/^# chartmuseum:/a chartmuseum:\n  enabled: true' harbor.yml && \
      sed -i '/^# trivy:/a trivy:\n  enabled: true' harbor.yml && \
      ./prepare && \
      ./install.sh" ]
